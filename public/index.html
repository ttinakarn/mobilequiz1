<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0", shrink-to-fit=no>
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.2/css/bootstrap.min.css" integrity="sha384-Smlep5jCw/wG7hdkwQ/Z5nLIefveQRIY9nfy6xoR1uRYBtpZgI6339F5dgvm/e9B" crossorigin="anonymous">
    <link rel="stylesheet" href="https://unpkg.com/onsenui/css/onsenui.css">
    <link rel="stylesheet" href="https://unpkg.com/onsenui/css/onsen-css-components.min.css">
    <script src="https://unpkg.com/onsenui/js/onsenui.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/material-design-iconic-font/2.2.0/css/material-design-iconic-font.min.css">
    <script src="https://code.jquery.com/jquery-3.3.1.js" integrity="sha256-2Kok7MbOyxpgUVvAk/HJ2jigOSYS2auK4Pfzbm7uH60=" crossorigin="anonymous"></script>
    <script src="ejs.js"></script>
    <script src="https://www.gstatic.com/firebasejs/5.5.0/firebase.js"></script>
    <script src="https://www.gstatic.com/firebasejs/5.3.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/5.4.1/firebase-firestore.js"></script>
    <script>
        var config = {
            apiKey: "AIzaSyAn6MsbK-EXDrWWANHjN_Mfh7MMTD0_VVo",
            authDomain: "shopee-b3287.firebaseapp.com",
            databaseURL: "https://shopee-b3287.firebaseio.com",
            projectId: "shopee-b3287",
            storageBucket: "shopee-b3287.appspot.com",
            messagingSenderId: "222099191341"
        };
        firebase.initializeApp(config);
        var db = firebase.firestore();
        db.settings({
            timestampsInSnapshots: true
        });
    </script>
    <title>PSU Mall</title>
</head>

<body>
    <ons-page>
        <ons-toolbar>
            <div class="center" id="appname">Home</div>
        </ons-toolbar>

        <ons-tabbar swipeable position="auto">
            <ons-tab page="tab1.html" label="Home" icon="ion-home, material:md-home" badge="5930213054" active>
            </ons-tab>
            <ons-tab page="tab2.html" label="Cart" icon="md-shopping-cart">
            </ons-tab>
            <ons-tab page="tab3.html" label="All Products" icon="md-apps">
            </ons-tab>
        </ons-tabbar>
    </ons-page>

    <template id="tab1.html">
        <ons-page id="Tab1">
            <br>
            <div style="text-align: center;">
                <ons-search-input placeholder="Search" onchange="ons.notification.alert('Searched for: ' + this.value)"></ons-search-input>
            </div>
            <ons-carousel swipeable auto-scroll overscrollable id="carousel" style="height: 170px;">
                <ons-carousel-item id="carousel1"></ons-carousel-item>
                <ons-carousel-item id="carousel2"></ons-carousel-item>
                <ons-carousel-item id="carousel3"></ons-carousel-item>
            </ons-carousel>
            <div id="icons"></div>
                <script id="icon_template" type="text/template">            
                    <ons-row height="150px">
                        <% categories.forEach(function(category){ %>
                            <ons-col style="<%= category.style %>" width="33%">
                                <p style="text-align: center;  margin: 10px;">
                                    <i class="<%= category.icon %>"></i>
                                </p>
                                <p style="text-align: center;"><%= category.name %></p>
                            </ons-col>
                        <% }); %>
                    </ons-row>
                </script>
            <br>
        </ons-page>
    </template>

    <template id="tab2.html">
        <ons-page id="Tab2">
            <ons-list>
                <ons-list-header>Shopping cart</ons-list-header>
                <ons-list-item>
                    <div class="left">
                        <img src="https://firebasestorage.googleapis.com/v0/b/shopee-b3287.appspot.com/o/item1.jpg?alt=media&token=423ff2c6-a4c2-4262-b251-2c49d3e4148f" style="height: 50px;">
                    </div>
                    <div class="center">
                        <ons-row>
                            <b>Apple Watch Series 3 GPS 42mm Gray</b>
                        </ons-row>
                        <ons-row style="color: rgb(38, 94, 248)">฿12,650.00</ons-row>
                    </div>
                    <div class="right">
                        <i class="zmdi zmdi-delete zmdi-hc-2x" style="color: grey"></i>
                    </div>
                </ons-list-item>
                <ons-list-item>
                    <div class="left">
                        <img src="https://firebasestorage.googleapis.com/v0/b/shopee-b3287.appspot.com/o/item2.jpg?alt=media&token=a24167a7-730c-4840-ba37-62d82398458b" style="height: 50px;">
                    </div>
                    <div class="center">
                        <ons-row>
                            <b>MICROLAB SPEAKER 2.1</b>
                        </ons-row>
                        <ons-row style="color: rgb(38, 94, 248)">฿1,570.00</ons-row>
                    </div>

                    <div class="right">
                        <i class="zmdi zmdi-delete zmdi-hc-2x" style="color: grey"></i>
                    </div>
                </ons-list-item>
                <ons-list-item>
                    <div class="left">
                        <img src="https://firebasestorage.googleapis.com/v0/b/shopee-b3287.appspot.com/o/item3.jpg?alt=media&token=8cc326d2-442e-49a4-bc75-a40bc76c24dd" style="height: 50px;">
                    </div>
                    <div class="center">
                        <ons-row>
                            <b>Nike Air Max 90 ดำเทาแดง เบอร์ 40</b>
                        </ons-row>
                        <ons-row style="color: rgb(38, 94, 248)">฿2,990.00</ons-row>
                    </div>

                    <div class="right">
                        <i class="zmdi zmdi-delete zmdi-hc-2x" style="color: grey"></i>
                    </div>
                </ons-list-item>
            </ons-list>
            <section style="padding: 8px">
                <ons-button modifier="large">PROCEED TO PAY</ons-button>
            </section>
        </ons-page>
    </template>

    <template id="tab3.html">
        <ons-page id="Tab3" >
            <section style="padding: 8px">
                <ons-button modifier="large" onclick="addNewData();">Add New Data</ons-button>
            </section>
            <div id="cards"></div>
            <script id="product_template" type="text/template">
                <div class="card-group" style="margin: auto;">
                    <div class="row" style="padding: 8px">
                        <% products.forEach(function(product){ %> 
                            <div class="card col-5" style="margin-right: auto; margin-left: auto;">
                                <img class="card-img-top" id="photo" src="images/<%= product.photo %>" alt="Card image">
                                <div class="card-body">
                                    <p class="card-title" style="font-size: 15px;"><%= product.title %></p>
                                    <p class="card-text" style="font-size: 13px;"><%= product.category %><br>price: ฿<%= product.price %></p>
                                </div> 
                            </div>
                        <% }); %>
                    </div>
                </div>
            </script>
        </ons-page>
    </template>

</body>
<script>
    getHomeData();
    //อันนี้เป็นตัวเช็คว่าปุ่มไหนโดนกด
    document.addEventListener('prechange', function (event) {
        if (event.index == 0) {
            console.log('Home clicked');
            //ถ้าคลิก home ให้เอาข้อมูลหน้า home มา show
            getHomeData();
        }
        else if (event.index == 1) {
            console.log('Cart clicked');
            //ถ้าคลิก cart ให้เอาข้อมูลหน้า cart มา show
            getCartData();
        }
        else if (event.index == 2) {
            console.log('All product clicked');
            getAllProduct();
        }
    });

    function getHomeData() {
        var docRef = db.collection("UI").doc("home");

        docRef.get().then(function(doc) 
        {
            if (doc.exists) {
                var data = doc.data();
                $('#appname').html(data.appname);
                for (var i = 0; i < data.slides.length; i++) {
                    let index = i + 1;
                    var style = "background: url('" + data.slides[i] + "') no-repeat center; background-size: contain;";                 
                    $('#carousel' + index).attr('style', style);
                }
                var icon_template = $('#icon_template').html();
                html = ejs.render(icon_template, {categories: data.categories});
                $('#icons').html(html);
            } 
            else {
                // doc.data() will be undefined in this case
                console.log("No db.collection(UI).doc(home)");
            }
        }).catch(function(error) {
            console.log("Error getting document:", error);
        });

        var productRef = db.collection('collection').doc('products');
        productRef.get().then(function(doc) 
        {
            if (doc.exists) {
                console.log("Document data:", doc.data());
                var data = doc.data();

                var product_template = $('#product_template').html();
                html = ejs.render(product_template, {products: data.product});
                $('#cards').html(html);
            }
            else {
                // doc.data() will be undefined in this case
                console.log("No such document!");
            }
        }).catch(function(error) {
            console.log("Error getting document:", error);
        });
    }

    function getCartData() {
        $.getJSON('cart.json', function (data) {
            console.log(data);
        })
    }

    function getAllProduct() {
        var allProductRef = db.collection("PRODUCTS").where("category", "==", "Sport");
        allProductRef.get().then(function(querySnapshot) {
            querySnapshot.forEach(function(doc) {
                // doc.data() is never undefined for query doc snapshots
                console.log(doc.id, " => ", doc.data());
            });
        });
    }

    function addNewData(){
        var data = {
            pid: 4,
            title: 'iPhoneXS',
            price: 50000,
            category: 'Smartphone', 
        }
        db.collection("PRODUCTS").add(data)
            .then(function(docRef) {
                console.log("Document written with ID: ", docRef.id);
            })
            .catch(function(error) {
                console.error("Error adding document: ", error);
            });
    }
</script>
<script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.2/js/bootstrap.min.js" integrity="sha384-o+RDsa0aLu++PJvFqy8fFScvbHFLtbvScb8AjopnFD+iEQ7wo/CG0xlczd+2O/em" crossorigin="anonymous"></script>

</html>